<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>城市选择的三种实现</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        
        fieldset {
            width: 500px;
            padding: 20px;
            margin: 30px;
            border: 1px solid #ccc;
        }
        
        legend {
            font-size: 18px;
            font-weight: bold;
        }
        
        #show {
            width: 200px;
            height: 25px;
            margin-bottom: 10px;
        }
        
        .btn {
            width: 80px;
            height: 30px;
            border-radius: 4px;
            border: 1px solid #ccc;
            outline: none;
            background-color: orange;
            margin: 0 20px;
        }
        
        .btn:disabled {
            background-color: #ccc;
        }
        /*方法一样式部分*/
        
        select {
            width: 120px;
            height: 30px;
        }
    </style>
</head>

<body>
    <div>
        <fieldset>
            <legend>下拉选择框实现省市区（县）三级联动</legend>
            <form action="#">
                <label for="show">您选择的是：
                    <input type="text" value="" id="show">
                </label>
                <br />

                <!--省份选择-->
                <select id="prov">
                    <option>=请选择省份=</option>
                </select>

                <!--城市选择-->
                <select id="city">
                    <option>=请选择城市=</option>
                </select>

                <!--县区选择-->
                <select id="country">
                    <option>=请选择县区=</option>
                </select>

                <button type="button" class="btn" id="btnclick">确定</button>
            </form>
        </fieldset>
    </div>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>
        //1.$.ajax(url,[settings])  通过 HTTP 请求加载远程数据 - 工具方法
        // $.ajax({
        //     type: 'post',
        //     url: 'http://localhost/JS2008/Day%2029-Day%2031_jquery/city.json',
        //     data: {

        //     },
        //     async: true,
        //     dataType: 'json',
        //     success: function(data) {
        //         console.log(data);
        //     },
        //     error: function() {

        //     }
        // });

        // $.ajax({
        //     type: 'post',
        //     url: 'http://localhost/JS2008/Day%2029-Day%2031_jquery/city.json',
        //     data: {

        //     },
        //     async: true,
        //     dataType: 'json'
        // }).done(function(data) {
        //     console.log(data);
        // }).fail(function() {

        // })

        //2.append(content|fn)向每个匹配的元素内部追加内容。
        //3.$.each(object, [callback])通用例遍方法，可用于例遍对象和数组。
        // $.each(arr, function(index, value) { //index:数组和对象属性，value:数组或者对象的值

        // });
        //4.:selected 匹配所有选中的option元素
        //5.attr(name|properties|key,value|fn)设置或返回被选元素的属性值(默认和自定义的)。prop获取默认的属性
        //6.first() 获取第一个元素
        //7.nextAll([expr])查找当前元素之后所有的同辈元素。
        //8.remove([expr])从DOM中删除所有匹配的元素。不是删除子元素。
        //9.val([val|fn|arr])读写表单元素的值(取代原生js表单的value)
    </script>
    <script>
        //三级联动菜单。
        //1.禁用点击按钮，等到设置了省市区，再点击
        //2.渲染省市区
        //先渲染省份，根据省份的变化，渲染城市，根据城市的变化，渲染县区。
        //3.渲染数据通过点击事件出入show文本框中。
        ! function($) {
            const show = $('#show');
            const prov = $('#prov');
            const city = $('#city');
            const country = $('#country');
            const btnclick = $('#btnclick');

            // 1.禁用点击按钮，等到设置了省市区，再点击
            btnclick.prop('disabled', true);

            // 2.渲染省市区
            $.ajax({
                url: 'http://localhost/JS2008/Day%2029-Day%2031_jquery/city.json',
                dataType: 'json'
            }).done(function(data) {
                console.log(data); //数组对象。
                //渲染省份
                //给每一个追加的option添加索引，索引和数组值的索引匹配。
                $.each(data, function(index, value) {
                    prov.append(`<option index="${index}">${value.name}</option>`);
                });

                //定义一个对象，存储省市区索引
                let objindex = {
                    prov: '',
                    city: '',
                    country: ''
                };

                //省份改变，渲染城市
                prov.on('change', function() {
                    //获取选中的option下面的自定义的属性。
                    let provindex = $('#prov>option:selected').attr('index');
                    //将省份的索引存储到定义的对象中，方便使用。
                    if (objindex.prov !== provindex) {
                        objindex.prov = provindex
                    }
                    if (provindex) {
                        let cityname = data[provindex].city; //返回值是数组
                        //清除前面渲染的值。
                        city.find('option').first().nextAll().remove();
                        //渲染城市
                        $.each(cityname, function(index, value) {
                            city.append(`<option index="${index}">${value.name}</option>`);
                        });
                    } else {
                        //清除前面渲染的值。
                        city.find('option').first().nextAll().remove();
                        //清除前面渲染的值。
                        country.find('option').first().nextAll().remove();
                    }
                });
                //城市改变，渲染县区
                city.on('change', function() {
                    //获取选中城市的索引
                    let cityindex = $('#city>option:selected').attr('index');
                    //将城市的索引存储到定义的对象中，方便使用。
                    if (objindex.city !== cityindex) {
                        objindex.city = cityindex
                    }
                    if (cityindex) {
                        let countryname = data[objindex.prov].city[cityindex].districtAndCounty; //返回值是数组
                        //清除前面渲染的值。
                        country.find('option').first().nextAll().remove();
                        //渲染县区
                        $.each(countryname, function(index, value) {
                            country.append(`<option index="${index}">${value}</option>`);
                        });
                    } else {
                        //清除前面渲染的值。
                        country.find('option').first().nextAll().remove();
                    }
                });


                //让确定按钮可以点击
                country.on('change', function() { //将城市的索引存储到定义的对象中，方便使用。
                    //获取选中县区的索引
                    let countryindex = $('#country>option:selected').attr('index');
                    if (objindex.country !== countryindex) {
                        objindex.country = countryindex
                    }
                    if (objindex.prov && objindex.city && objindex.country) {
                        btnclick.prop('disabled', false);
                    }
                });

                //点击确定按钮，将对应的数据填充到show文本框中。
                btnclick.on('click', function() {
                    show.val(data[objindex.prov].name + '-' + data[objindex.prov].city[objindex.city].name + '-' + data[objindex.prov].city[objindex.city].districtAndCounty[objindex.country]);
                });
            });



        }(jQuery);
    </script>
</body>

</html>